<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="theme-color" content="#6366f1" />
    <title>ComercioPro - Gesti√≥n Inteligente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");

      * {
        font-family: "Inter", sans-serif;
        -webkit-tap-highlight-color: transparent;
        box-sizing: border-box;
      }

      body {
        overscroll-behavior-y: none;
        background: #f8fafc;
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow: hidden;
      }

      #app {
        height: 100vh;
        display: flex;
        flex-direction: column;
        max-width: 100%;
      }

      .glass-effect {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(10px);
      }

      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .card-shadow {
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      }

      .bottom-nav-item {
        transition: all 0.2s ease;
        border: none;
        background: none;
        cursor: pointer;
      }

      .bottom-nav-item.active {
        color: #6366f1;
      }

      .slide-in {
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .hidden-section {
        display: none !important;
      }

      /* Scanner Styles */
      .scanner-container {
        position: fixed;
        inset: 0;
        background: black;
        z-index: 100;
        display: flex;
        flex-direction: column;
      }

      .scanner-header {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        padding: 16px;
        background: linear-gradient(to bottom, rgba(0, 0, 0, 0.8), transparent);
        z-index: 10;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .scanner-frame {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 280px;
        height: 180px;
        border: 2px solid rgba(255, 255, 255, 0.5);
        border-radius: 12px;
        pointer-events: none;
      }

      .scanner-corner {
        position: absolute;
        width: 20px;
        height: 20px;
        border-color: #6366f1;
        border-style: solid;
        border-width: 0;
      }

      .scanner-corner.top-left {
        top: -2px;
        left: -2px;
        border-top-width: 4px;
        border-left-width: 4px;
      }

      .scanner-corner.top-right {
        top: -2px;
        right: -2px;
        border-top-width: 4px;
        border-right-width: 4px;
      }

      .scanner-corner.bottom-left {
        bottom: -2px;
        left: -2px;
        border-bottom-width: 4px;
        border-left-width: 4px;
      }

      .scanner-corner.bottom-right {
        bottom: -2px;
        right: -2px;
        border-bottom-width: 4px;
        border-right-width: 4px;
      }

      .scan-line {
        position: absolute;
        left: 0;
        right: 0;
        height: 2px;
        background: #6366f1;
        box-shadow:
          0 0 10px #6366f1,
          0 0 20px #6366f1;
        animation: scan 2s linear infinite;
      }

      @keyframes scan {
        0% {
          top: 0;
          opacity: 0;
        }
        10% {
          opacity: 1;
        }
        90% {
          opacity: 1;
        }
        100% {
          top: 100%;
          opacity: 0;
        }
      }

      .scanner-overlay {
        position: absolute;
        inset: 0;
        background: linear-gradient(
          to bottom,
          rgba(0, 0, 0, 0.6) 0%,
          rgba(0, 0, 0, 0) 25%,
          rgba(0, 0, 0, 0) 75%,
          rgba(0, 0, 0, 0.6) 100%
        );
        pointer-events: none;
      }

      .scanner-footer {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 24px;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
        z-index: 10;
      }

      #reader {
        width: 100% !important;
        height: 100% !important;
        overflow: hidden !important;
      }

      #reader video {
        width: 100% !important;
        height: 100% !important;
        object-fit: cover !important;
      }

      /* Manual Entry Fallback */
      .manual-entry {
        background: white;
        padding: 20px;
        border-radius: 16px;
        margin: 20px;
      }

      .product-card {
        transition: transform 0.2s;
        cursor: pointer;
      }

      .product-card:active {
        transform: scale(0.96);
      }

      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 100;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 16px;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 16px;
        width: 100%;
        max-width: 400px;
        max-height: 90vh;
        overflow-y: auto;
        animation: slideUp 0.3s ease-out;
      }

      @keyframes slideUp {
        from {
          transform: translateY(100%);
        }
        to {
          transform: translateY(0);
        }
      }

      .btn-primary {
        background: #6366f1;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        transition: opacity 0.2s;
      }

      .btn-primary:active {
        opacity: 0.8;
      }

      .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-secondary {
        background: #e5e7eb;
        color: #374151;
        border: none;
        padding: 12px 24px;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
      }

      .input-field {
        width: 100%;
        padding: 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 16px;
        margin-top: 4px;
      }

      .input-field:focus {
        outline: none;
        border-color: #6366f1;
      }

      .error-toast {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: #ef4444;
        color: white;
        padding: 12px 24px;
        border-radius: 24px;
        font-size: 14px;
        z-index: 200;
        animation: fadeIn 0.3s;
        display: none;
      }

      .error-toast.show {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateX(-50%) translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
      }

      .scan-history {
        max-height: 150px;
        overflow-y: auto;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 8px;
        margin-top: 10px;
      }

      .scan-history-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        font-size: 12px;
        color: white;
      }

      .scan-history-item:last-child {
        border-bottom: none;
      }

      /* Split Screen Sale Layout - Full Screen */
      .sale-modal-split {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background: white !important;
        z-index: 2000 !important;
        display: none !important;
        padding: 0 !important;
        margin: 0 !important;
      }

      .sale-modal-split.active {
        display: flex !important;
        flex-direction: column !important;
        width: 100vw !important;
        height: 100vh !important;
      }

      .sale-modal-split.active .modal-content {
        background: white !important;
        border-radius: 0 !important;
        flex: 1 !important;
        width: 100vw !important;
        display: flex !important;
        flex-direction: column !important;
        overflow: hidden !important;
        box-shadow: none !important;
        margin: 0 !important;
        padding: 0 !important;
        min-height: 0 !important;
      }

      .sale-modal-split.active .sale-list-section {
        flex: 0 0 35% !important;
        display: flex !important;
        flex-direction: column !important;
        background: #fff !important;
        overflow: hidden !important;
        border-radius: 0 !important;
        border-bottom: 2px solid #e5e7eb !important;
        order: 1 !important;
      }

      .sale-modal-split.active .sale-scanner-section {
        flex: 1 !important;
        background: #000 !important;
        position: relative !important;
        overflow: hidden !important;
        display: flex !important;
        flex-direction: column !important;
        min-height: auto !important;
        order: 2 !important;
      }

      .sale-modal-header-split {
        position: relative;
        top: 0;
        left: 0;
        right: 0;
        padding: 12px 16px;
        background: linear-gradient(to bottom, rgba(0, 0, 0, 0.7), transparent);
        z-index: 20;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: white;
        flex-shrink: 0;
      }

      .sale-modal-header-split.right {
        left: 0;
        right: 0;
        background: linear-gradient(to bottom, rgba(255, 255, 255, 0.98), transparent);
        padding: 12px 16px;
        color: #1f2937;
        position: relative;
        top: 0;
      }

      .sale-modal-header-split.right button {
        color: #9ca3af;
      }

      .sale-modal-split.active .sale-scanner-inner {
        position: relative !important;
        width: 100% !important;
        flex: 1 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        overflow: hidden !important;
        background: #000 !important;
        min-height: 0 !important;
      }

      #sale-reader {
        width: 100% !important;
        height: 100% !important;
        overflow: hidden !important;
        border-radius: 0 !important;
        z-index: 1 !important;
        display: flex !important;
        flex: 1 !important;
      }

      .sale-modal-split.active #sale-reader {
        width: 100% !important;
        height: 100% !important;
        flex: 1 !important;
        overflow: hidden !important;
        border-radius: 0 !important;
        z-index: 1 !important;
        display: flex !important;
        min-height: 0 !important;
      }

      #sale-reader video {
        width: 100% !important;
        height: 100% !important;
        object-fit: cover !important;
      }

      #sale-reader > * {
        width: 100% !important;
        height: 100% !important;
      }

      /* Ensure html5-qrcode elements display correctly */
      #sale-reader [role="main"] {
        width: 100% !important;
        height: 100% !important;
      }

      .sale-scanner-frame {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 240px;
        height: 140px;
        border: 2px solid rgba(255, 255, 255, 0.5);
        border-radius: 12px;
        pointer-events: none;
        z-index: 15;
        transition: all 0.3s;
      }

      .sale-scanner-frame .scan-line {
        position: absolute;
        left: 0;
        right: 0;
        height: 2px;
        background: #6366f1;
        box-shadow: 0 0 10px #6366f1;
        animation: scan 2s linear infinite;
      }

      .sale-scanner-overlay {
        position: absolute;
        inset: 0;
        background: linear-gradient(
          to bottom,
          rgba(0, 0, 0, 0.6) 0%,
          rgba(0, 0, 0, 0) 25%,
          rgba(0, 0, 0, 0) 75%,
          rgba(0, 0, 0, 0.6) 100%
        );
        pointer-events: none;
        z-index: 12;
      }

      .sale-manual-entry {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 16px;
        background: linear-gradient(
          to top,
          rgba(0, 0, 0, 0.95),
          rgba(0, 0, 0, 0.7),
          transparent
        );
        z-index: 20;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .sale-cart-items {
        flex: 1;
        overflow-y: auto;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-height: 0;
      }

      .sale-cart-items::-webkit-scrollbar {
        width: 6px;
      }

      .sale-cart-items::-webkit-scrollbar-track {
        background: transparent;
      }

      .sale-cart-items::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 3px;
      }

      .sale-cart-footer {
        padding: 16px;
        border-top: 2px solid #e5e7eb;
        background: #f9fafb;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .sale-cart-footer .btn-primary {
        margin: 0;
        padding: 14px 16px;
        font-size: 15px;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <!-- Header -->
      <header
        class="glass-effect sticky top-0 z-40 px-4 py-3 border-b border-gray-200 flex-none"
      >
        <div class="flex justify-between items-center">
          <div class="flex items-center gap-2">
            <div
              class="w-8 h-8 gradient-bg rounded-lg flex items-center justify-center text-white font-bold"
            >
              C
            </div>
            <h1 id="pageTitle" class="text-lg font-bold text-gray-800">
              Dashboard
            </h1>
          </div>
          <button
            onclick="app.navigateTo('settings')"
            class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center"
          >
            <svg
              class="w-5 h-5 text-gray-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
              ></path>
            </svg>
          </button>
        </div>
      </header>

      <!-- Main Content -->
      <main
        id="mainContent"
        class="flex-1 overflow-y-auto no-scrollbar p-4 pb-24"
      >
        <!-- DASHBOARD -->
        <section id="dashboard" class="space-y-4 slide-in">
          <div class="grid grid-cols-2 gap-3">
            <div class="bg-white p-4 rounded-2xl card-shadow">
              <div class="text-xs text-gray-500 mb-1">Ventas Hoy</div>
              <div class="text-xl font-bold text-gray-800" id="todaySales">
                $0.00
              </div>
            </div>
            <div class="bg-white p-4 rounded-2xl card-shadow">
              <div class="text-xs text-gray-500 mb-1">Productos</div>
              <div class="text-xl font-bold text-gray-800" id="totalProducts">
                0
              </div>
            </div>
          </div>

          <div
            class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl p-4 text-white"
          >
            <h3 class="font-semibold mb-3 text-sm">Acciones R√°pidas</h3>
            <div class="flex gap-2">
              <button
                onclick="app.quickSale()"
                class="flex-1 bg-white/20 backdrop-blur rounded-xl py-3 text-sm font-medium active:bg-white/30 transition"
              >
                + Nueva Venta
              </button>
              <button
                onclick="app.openScanner('search')"
                class="flex-1 bg-white/20 backdrop-blur rounded-xl py-3 text-sm font-medium active:bg-white/30 transition"
              >
                üì∑ Escanear
              </button>
            </div>
          </div>

          <div class="bg-white p-4 rounded-2xl card-shadow">
            <h3 class="font-semibold text-gray-800 mb-3 text-sm">
              Ventas de la Semana
            </h3>
            <div style="height: 200px">
              <canvas id="salesChart"></canvas>
            </div>
          </div>

          <div class="bg-white p-4 rounded-2xl card-shadow">
            <div class="flex justify-between items-center mb-3">
              <h3 class="font-semibold text-gray-800 text-sm">
                √öltimas Ventas
              </h3>
              <button
                onclick="app.navigateTo('sales')"
                class="text-indigo-600 text-xs"
              >
                Ver todas
              </button>
            </div>
            <div id="recentSalesList" class="space-y-2">
              <div class="text-center text-gray-400 py-4 text-sm">
                Sin ventas recientes
              </div>
            </div>
          </div>
        </section>

        <!-- PRODUCTS -->
        <section id="products" class="hidden-section space-y-4 slide-in">
          <div class="flex gap-2">
            <div class="flex-1 relative">
              <input
                type="text"
                id="searchInput"
                placeholder="Buscar producto..."
                class="input-field pl-10"
                oninput="app.filterProducts()"
              />
              <svg
                class="w-5 h-5 text-gray-400 absolute left-3 top-3.5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                ></path>
              </svg>
            </div>
            <button
              onclick="app.openScanner('new')"
              class="bg-indigo-600 text-white px-4 rounded-xl flex items-center justify-center active:opacity-80 transition"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 4v16m8-8H4"
                ></path>
              </svg>
            </button>
          </div>

          <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2">
            <button
              onclick="app.setCategory('all')"
              class="category-btn px-4 py-2 bg-indigo-600 text-white rounded-full text-xs font-medium whitespace-nowrap"
              data-cat="all"
            >
              Todos
            </button>
            <button
              onclick="app.setCategory('almacen')"
              class="category-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-xs font-medium whitespace-nowrap"
              data-cat="almacen"
            >
              Almac√©n
            </button>
            <button
              onclick="app.setCategory('limpieza')"
              class="category-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-xs font-medium whitespace-nowrap"
              data-cat="limpieza"
            >
              Limpieza
            </button>
            <button
              onclick="app.setCategory('perfumeria')"
              class="category-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-xs font-medium whitespace-nowrap"
              data-cat="perfumeria"
            >
              Perfumer√≠a
            </button>
            <button
              onclick="app.setCategory('bebidas')"
              class="category-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-xs font-medium whitespace-nowrap"
              data-cat="bebidas"
            >
              Bebidas
            </button>
            <button
              onclick="app.setCategory('cigarrillos')"
              class="category-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-xs font-medium whitespace-nowrap"
              data-cat="cigarrillos"
            >
              Cigarrillos
            </button>
            <button
              onclick="app.setCategory('verduras')"
              class="category-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-xs font-medium whitespace-nowrap"
              data-cat="verduras"
            >
              Verduras
            </button>
            <button
              onclick="app.setCategory('lacteos')"
              class="category-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-xs font-medium whitespace-nowrap"
              data-cat="lacteos"
            >
              L√°cteos
            </button>
            <button
              onclick="app.setCategory('fiambreria')"
              class="category-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-xs font-medium whitespace-nowrap"
              data-cat="fiambreria"
            >
              Fiambrer√≠a
            </button>
          </div>

          <div id="productsGrid" class="grid grid-cols-2 gap-3">
            <!-- Products rendered here -->
          </div>
        </section>

        <!-- SALES -->
        <section id="sales" class="hidden-section space-y-4 slide-in">
          <button
            onclick="app.openSaleModal()"
            class="w-full bg-green-500 text-white py-4 rounded-2xl font-semibold shadow-lg active:opacity-80 transition flex items-center justify-center gap-2"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 6v6m0 0v6m0-6h6m-6 0H6"
              ></path>
            </svg>
            Nueva Venta
          </button>

          <div id="salesList" class="space-y-3">
            <!-- Sales rendered here -->
          </div>
        </section>

        <!-- REPORTS -->
        <section id="reports" class="hidden-section space-y-4 slide-in">
          <div class="bg-white p-4 rounded-2xl card-shadow">
            <div class="flex gap-2 mb-4">
              <button
                onclick="app.setReportRange('day')"
                class="report-range-btn flex-1 py-2 text-xs rounded-lg bg-indigo-100 text-indigo-700 font-medium"
                data-range="day"
              >
                D√≠a
              </button>
              <button
                onclick="app.setReportRange('week')"
                class="report-range-btn flex-1 py-2 text-xs rounded-lg bg-gray-100 text-gray-600"
                data-range="week"
              >
                Semana
              </button>
              <button
                onclick="app.setReportRange('month')"
                class="report-range-btn flex-1 py-2 text-xs rounded-lg bg-gray-100 text-gray-600"
                data-range="month"
              >
                Mes
              </button>
            </div>
            <div style="height: 200px">
              <canvas id="reportChart"></canvas>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="bg-white p-4 rounded-2xl card-shadow">
              <div class="text-lg font-bold text-indigo-600" id="reportTotal">
                $0.00
              </div>
              <div class="text-xs text-gray-500">Total Ventas</div>
            </div>
            <div class="bg-white p-4 rounded-2xl card-shadow">
              <div class="text-lg font-bold text-green-600" id="reportItems">
                0
              </div>
              <div class="text-xs text-gray-500">Productos Vendidos</div>
            </div>
          </div>
        </section>

        <!-- SETTINGS -->
        <section id="settings" class="hidden-section space-y-4 slide-in">
          <div class="bg-white rounded-2xl card-shadow overflow-hidden">
            <div class="p-4 gradient-bg text-white">
              <div class="flex items-center gap-3">
                <div
                  class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center text-2xl"
                >
                  üè™
                </div>
                <div>
                  <h3 class="font-bold" id="settingsBusinessName">
                    Mi Comercio
                  </h3>
                  <p class="text-white/80 text-xs" id="settingsBusinessType">
                    Tienda General
                  </p>
                </div>
              </div>
            </div>
            <div class="p-4">
              <button
                onclick="app.editBusiness()"
                class="w-full text-left py-2 text-sm text-indigo-600 font-medium"
              >
                Editar informaci√≥n
              </button>
            </div>
          </div>

          <div
            class="bg-white rounded-2xl card-shadow divide-y divide-gray-100"
          >
            <div class="p-4 flex justify-between items-center">
              <span class="text-sm font-medium">Moneda</span>
              <button
                onclick="app.toggleCurrency()"
                class="text-indigo-600 text-sm font-medium"
                id="currencyDisplay"
              >
                USD ($)
              </button>
            </div>
            <div class="p-4 flex justify-between items-center">
              <span class="text-sm font-medium">Imprimir tickets</span>
              <input
                type="checkbox"
                id="printTickets"
                checked
                class="w-5 h-5 accent-indigo-600"
                onchange="app.saveSettings()"
              />
            </div>
            <div class="p-4">
              <button
                onclick="app.exportData()"
                class="w-full text-left text-sm font-medium text-gray-700 mb-2"
              >
                üì• Exportar datos
              </button>
              <button
                onclick="app.importData()"
                class="w-full text-left text-sm font-medium text-gray-700"
              >
                üì§ Importar datos
              </button>
            </div>
          </div>

          <button
            onclick="app.clearData()"
            class="w-full bg-red-50 text-red-600 py-3 rounded-2xl font-medium text-sm border border-red-200 active:bg-red-100 transition"
          >
            Borrar todos los datos
          </button>

          <div class="text-center text-gray-400 text-xs pt-4">
            ComercioPro v1.1.0
          </div>
        </section>
      </main>

      <!-- Bottom Navigation -->
      <nav
        id="bottomNav"
        class="glass-effect border-t border-gray-200"
        style="
          padding: 8px 0;
          background: rgba(255, 255, 255, 0.98);
          position: fixed;
          left: 0;
          right: 0;
          bottom: 0;
          z-index: 60;
        "
      >
        <div class="flex justify-around items-center h-full">
          <button
            onclick="app.navigateTo('dashboard')"
            class="bottom-nav-item active flex flex-col items-center justify-center gap-1.5 flex-1 h-20 text-gray-500 transition-colors rounded-lg mx-1"
            data-page="dashboard"
          >
            <svg
              class="w-7 h-7"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
              ></path>
            </svg>
            <span class="text-xs font-semibold leading-tight">Inicio</span>
          </button>

          <button
            onclick="app.navigateTo('products')"
            class="bottom-nav-item flex flex-col items-center justify-center gap-1.5 flex-1 h-20 text-gray-500 transition-colors rounded-lg mx-1"
            data-page="products"
          >
            <svg
              class="w-7 h-7"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
              ></path>
            </svg>
            <span class="text-xs font-semibold leading-tight">Productos</span>
          </button>

          <button
            onclick="app.navigateTo('sales')"
            class="bottom-nav-item flex flex-col items-center justify-center gap-1.5 flex-1 h-20 text-gray-500 transition-colors rounded-lg mx-1"
            data-page="sales"
          >
            <svg
              class="w-7 h-7"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
              ></path>
            </svg>
            <span class="text-xs font-semibold leading-tight">Ventas</span>
          </button>

          <button
            onclick="app.navigateTo('reports')"
            class="bottom-nav-item flex flex-col items-center justify-center gap-1.5 flex-1 h-20 text-gray-500 transition-colors rounded-lg mx-1"
            data-page="reports"
          >
            <svg
              class="w-7 h-7"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
              ></path>
            </svg>
            <span class="text-xs font-semibold leading-tight">Reportes</span>
          </button>

          <button
            onclick="app.navigateTo('settings')"
            class="bottom-nav-item flex flex-col items-center justify-center gap-1.5 flex-1 h-20 text-gray-500 transition-colors rounded-lg mx-1"
            data-page="settings"
          >
            <svg
              class="w-7 h-7"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
              ></path>
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
              ></path>
            </svg>
            <span class="text-xs font-semibold leading-tight">Ajustes</span>
          </button>
        </div>
      </nav>
    </div>

    <!-- Scanner Interface -->
    <div id="scannerInterface" class="scanner-container hidden-section">
      <div class="scanner-header">
        <h2 class="text-white font-semibold text-lg">Escanear C√≥digo</h2>
        <button
          onclick="app.closeScanner()"
          class="w-10 h-10 bg-white/20 backdrop-blur rounded-full flex items-center justify-center text-white"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </button>
      </div>

      <div id="reader"></div>

      <div class="scanner-frame">
        <div class="scanner-corner top-left"></div>
        <div class="scanner-corner top-right"></div>
        <div class="scanner-corner bottom-left"></div>
        <div class="scanner-corner bottom-right"></div>
        <div class="scan-line"></div>
      </div>

      <div class="scanner-overlay"></div>

      <div class="scanner-footer">
        <p class="text-white/90 text-center text-sm mb-3">
          Centra el c√≥digo de barras en el recuadro
        </p>

        <!-- Last Scanned -->
        <div
          id="lastScanned"
          class="text-center text-white/70 text-xs mb-3"
          style="display: none"
        >
          √öltimo escaneado:
          <span id="lastScannedCode" class="text-white font-mono"></span>
        </div>

        <!-- Manual Entry -->
        <div class="flex gap-2 mb-3">
          <input
            type="text"
            id="manualBarcode"
            placeholder="O escribe el c√≥digo manualmente..."
            class="flex-1 bg-white/20 backdrop-blur text-white placeholder-white/60 px-4 py-3 rounded-xl border border-white/30 text-sm"
          />
          <button
            onclick="app.manualScan()"
            class="bg-white text-gray-900 px-4 py-3 rounded-xl font-medium text-sm active:opacity-80"
          >
            Buscar
          </button>
        </div>

        <!-- Scan History -->
        <div id="scanHistoryContainer" style="display: none">
          <div class="text-white/60 text-xs mb-1">Escaneos recientes:</div>
          <div id="scanHistory" class="scan-history"></div>
        </div>

        <div class="flex justify-center gap-4 mt-3">
          <button
            onclick="app.toggleTorch()"
            class="w-12 h-12 bg-white/20 backdrop-blur rounded-full flex items-center justify-center text-white"
            id="torchBtn"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 10V3L4 14h7v7l9-11h-7z"
              ></path>
            </svg>
          </button>
          <button
            onclick="app.switchCamera()"
            class="w-12 h-12 bg-white/20 backdrop-blur rounded-full flex items-center justify-center text-white"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
              ></path>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal">
      <div class="modal-content p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold text-gray-900" id="productModalTitle">
            Nuevo Producto
          </h3>
          <button
            onclick="app.closeModal('productModal')"
            class="text-gray-400 hover:text-gray-600 transition"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>

        <form id="productForm" onsubmit="app.saveProduct(event)">
          <input type="hidden" id="productBarcode" />

          <div class="mb-4">
            <label class="block text-xs font-semibold text-gray-700 mb-2"
              >C√≥digo de Barras</label
            >
            <div class="flex gap-2">
              <input
                type="text"
                id="displayBarcode"
                readonly
                class="input-field bg-gray-100 flex-1 font-mono text-sm"
                placeholder="C√≥digo..."
              />
              <button
                type="button"
                onclick="app.rescanBarcode()"
                class="bg-indigo-100 text-indigo-600 px-4 py-2 rounded-lg flex items-center hover:bg-indigo-200 transition font-medium text-sm whitespace-nowrap"
              >
                üì∑
              </button>
            </div>
            <p class="text-xs text-gray-500 mt-1">
              Puedes editar el c√≥digo manualmente
            </p>
          </div>

          <div class="mb-4">
            <label class="block text-xs font-semibold text-gray-700 mb-2"
              >Nombre del Producto *</label
            >
            <input
              type="text"
              id="productName"
              required
              class="input-field"
              placeholder="Ej: Coca Cola 600ml"
              maxlength="100"
            />
          </div>

          <div class="grid grid-cols-2 gap-3 mb-4">
            <div>
              <label class="block text-xs font-semibold text-gray-700 mb-2"
                >Precio *</label
              >
              <input
                type="number"
                id="productPrice"
                step="0.01"
                min="0"
                required
                class="input-field"
                placeholder="0.00"
                title="Precio del producto"
              />
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-700 mb-2"
                >Stock *</label
              >
              <input
                type="number"
                id="productStock"
                min="0"
                required
                class="input-field"
                placeholder="0"
                title="Cantidad en stock"
              />
            </div>
          </div>

          <div class="mb-4">
            <label class="block text-xs font-semibold text-gray-700 mb-2"
              >Categor√≠a</label
            >
            <select id="productCategory" class="input-field">
              <option value="almacen">üè¨ Almac√©n</option>
              <option value="limpieza">üßº Limpieza</option>
              <option value="perfumeria">üíÑ Perfumer√≠a</option>
              <option value="bebidas">ü•§ Bebidas</option>
              <option value="cigarrillos">üö¨ Cigarrillos</option>
              <option value="verduras">ü•¶ Verduras</option>
              <option value="lacteos">ü•õ L√°cteos</option>
              <option value="fiambreria">ü•© Fiambrer√≠a</option>
            </select>
          </div>

          <button type="submit" class="btn-primary mb-2">
            ‚úì Guardar Producto
          </button>
          <button
            type="button"
            onclick="app.closeModal('productModal')"
            class="btn-secondary"
          >
            Cancelar
          </button>
        </form>
      </div>
    </div>

    <!-- Sale Modal -->
    <div id="saleModal" class="modal">
      <div
        class="modal-content flex flex-col"
        style="max-height: 90vh; height: 90vh"
      >
        <!-- Header for normal mode -->
        <div
          id="saleHeader"
          class="p-4 border-b border-gray-200 flex justify-between items-center flex-none bg-gradient-to-r from-indigo-50 to-blue-50"
        >
          <h3 class="text-lg font-bold text-gray-900">Nueva Venta</h3>
          <button
            onclick="app.closeModal('saleModal')"
            class="text-gray-400 hover:text-gray-600 transition"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>

        <div id="saleContent" class="flex-1 overflow-y-auto p-4 space-y-3">
          <div id="cartItems" class="space-y-2">
            <div class="text-center text-gray-400 py-8 text-sm">
              Carrito vac√≠o ‚Ä¢ Escanea un producto
            </div>
          </div>

          <div
            class="sticky bottom-0 bg-white pt-3 border-t border-gray-200 space-y-2"
          >
            <button
              onclick="app.openScannerInSale()"
              class="w-full border-2 border-indigo-300 border-dashed rounded-xl py-3 text-indigo-600 text-sm font-medium active:bg-indigo-50 transition"
            >
              üì∑ Escanear Producto
            </button>
            <button
              onclick="app.showProductSelector()"
              class="w-full border-2 border-gray-300 border-dashed rounded-xl py-3 text-gray-600 text-sm font-medium active:bg-gray-50 transition"
            >
              üìã Seleccionar de Lista
            </button>
          </div>
        </div>

        <div
          class="p-4 border-t border-gray-200 bg-gradient-to-r from-gray-50 to-blue-50 flex-none rounded-b-2xl space-y-3"
        >
          <div class="flex justify-between items-center">
            <span class="font-bold text-gray-700">Total:</span>
            <span id="cartTotal" class="text-2xl font-bold text-indigo-600"
              >$0.00</span
            >
          </div>
          <div class="flex gap-2">
            <button
              onclick="app.closeModal('saleModal')"
              class="flex-1 bg-gray-200 text-gray-800 py-3 rounded-xl font-medium text-sm active:opacity-80"
            >
              Cancelar
            </button>
            <button
              onclick="app.completeSale()"
              id="completeSaleBtn"
              disabled
              class="flex-1 btn-primary"
              style="opacity: 0.5"
            >
              ‚úì Completar Venta
            </button>
          </div>
        </div>
      </div>

      <!-- Split screen layout (hidden by default) -->
      <div id="saleSplitContainer" class="sale-modal-split">
        <div class="modal-content">
          <!-- Scanner Section (Left) -->
          <div class="sale-scanner-section">
            <div class="sale-modal-header-split">
              <h2 class="text-white font-semibold text-sm">üì∑ Esc√°ner</h2>
              <span class="text-white/70 text-xs"
                >Escanea para agregar productos</span
              >
            </div>

            <div class="sale-scanner-inner flex-1">
              <div id="sale-reader"></div>

              <div class="sale-scanner-frame">
                <div
                  class="scanner-corner top-left"
                  style="border-color: #6366f1"
                ></div>
                <div
                  class="scanner-corner top-right"
                  style="border-color: #6366f1"
                ></div>
                <div
                  class="scanner-corner bottom-left"
                  style="border-color: #6366f1"
                ></div>
                <div
                  class="scanner-corner bottom-right"
                  style="border-color: #6366f1"
                ></div>
                <div class="scan-line"></div>
              </div>

              <div class="sale-scanner-overlay"></div>
            </div>

            <div class="sale-manual-entry">
              <div class="flex gap-2 mb-2">
                <input
                  type="text"
                  id="saleScannerInput"
                  placeholder="O escribe el c√≥digo..."
                  class="flex-1 bg-white/20 backdrop-blur text-white placeholder-white/50 px-3 py-2 rounded-lg border border-white/30 text-sm focus:outline-none focus:border-white/50"
                />
                <button
                  onclick="app.manualScanInSale()"
                  class="bg-white text-gray-900 px-3 py-2 rounded-lg font-medium text-sm active:opacity-80 hover:bg-gray-100 transition"
                >
                  Buscar
                </button>
              </div>
              <button
                onclick="app.closeSplitSale()"
                class="w-full bg-red-600 hover:bg-red-700 text-white py-2.5 rounded-lg text-sm font-medium active:bg-red-800 transition"
              >
                ‚úï Cerrar Venta
              </button>
            </div>
          </div>

          <!-- Cart Section (Right) -->
          <div class="sale-list-section">
            <div class="sale-modal-header-split right">
              <div>
                <h2 class="font-semibold text-gray-900 text-sm">
                  üõí Carrito de Compra
                </h2>
                <p id="cartItemCount" class="text-xs text-gray-500 mt-0.5">
                  0 productos
                </p>
              </div>
              <button
                onclick="app.closeSplitSale()"
                class="text-gray-400 hover:text-gray-600 transition"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  ></path>
                </svg>
              </button>
            </div>

            <div class="sale-cart-items" id="splitCartItems">
              <div class="text-center text-gray-400 py-4 text-sm">
                Carrito vac√≠o ‚Ä¢ Escanea productos
              </div>
            </div>

            <div class="sale-cart-footer">
              <div class="flex justify-between items-center px-2">
                <span class="font-bold text-gray-700">Total:</span>
                <span
                  id="splitCartTotal"
                  class="text-3xl font-bold text-indigo-600"
                  >$0.00</span
                >
              </div>
              <button
                onclick="app.completeSaleFromSplit()"
                id="splitCompleteSaleBtn"
                disabled
                class="w-full btn-primary"
                style="opacity: 0.5"
              >
                ‚úì Completar Venta
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Product Selector Modal -->
    <div id="productSelectorModal" class="modal">
      <div class="modal-content flex flex-col" style="max-height: 80vh">
        <div
          class="p-4 border-b border-gray-200 flex justify-between items-center bg-gradient-to-r from-indigo-50 to-blue-50"
        >
          <h3 class="text-lg font-bold text-gray-900">Seleccionar Producto</h3>
          <button
            onclick="app.closeModal('productSelectorModal')"
            class="text-gray-400 hover:text-gray-600 transition"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <div class="p-4 flex-none border-b border-gray-200">
          <div class="relative">
            <input
              type="text"
              id="selectorSearch"
              placeholder="Buscar producto..."
              class="input-field pl-10"
              oninput="app.filterSelector()"
            />
            <svg
              class="w-5 h-5 text-gray-400 absolute left-3 top-3.5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
              ></path>
            </svg>
          </div>
        </div>
        <div class="p-4 overflow-y-auto flex-1">
          <div id="selectorList" class="space-y-2">
            <!-- Products -->
          </div>
        </div>
      </div>
    </div>

    <!-- Ticket Modal -->
    <div id="ticketModal" class="modal">
      <div class="modal-content p-6 text-center">
        <div
          class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3"
        >
          <svg
            class="w-8 h-8 text-green-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M5 13l4 4L19 7"
            ></path>
          </svg>
        </div>
        <h3 class="text-lg font-bold mb-4">¬°Venta Completada!</h3>

        <div
          id="ticketContent"
          class="bg-gray-50 p-4 rounded-xl mb-4 text-left font-mono text-xs space-y-1"
        >
          <!-- Ticket content -->
        </div>

        <div class="flex gap-3">
          <button
            onclick="app.closeModal('ticketModal')"
            class="flex-1 bg-gray-200 text-gray-800 py-3 rounded-xl font-medium text-sm"
          >
            Cerrar
          </button>
          <button
            onclick="app.shareTicket()"
            class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-medium text-sm"
          >
            Compartir
          </button>
        </div>
      </div>
    </div>

    <!-- Error Toast -->
    <div id="errorToast" class="error-toast"></div>

    <script>
      const app = {
        data: {
          products: [],
          sales: [],
          settings: {
            businessName: "Mi Comercio",
            businessType: "Tienda General",
            currency: "USD",
            printTickets: true,
          },
        },
        currentCart: [],
        scanner: null,
        currentCamera: "environment",
        scanHistory: [],
        scanMode: null,
        charts: {},

        init() {
          this.loadData();
          this.setupCharts();
          this.updateDashboard();
          this.renderProducts();
          this.renderSales();
          this.updateSettingsUI();
          // Adjust bottom navigation placement according to screen
          this.adjustBottomNav();
          window.addEventListener("resize", () => this.adjustBottomNav());
          window.addEventListener("orientationchange", () =>
            this.adjustBottomNav(),
          );

          if (this.data.products.length === 0) {
            this.addDemoData();
          }
        },

        loadData() {
          try {
            const saved = localStorage.getItem("comercioProData");
            if (saved) {
              this.data = JSON.parse(saved);
            }
          } catch (e) {
            console.error("Error loading data:", e);
          }
        },

        saveData() {
          try {
            localStorage.setItem("comercioProData", JSON.stringify(this.data));
          } catch (e) {
            this.showError("Error al guardar datos");
          }
        },

        adjustBottomNav() {
          // Position bottom navigation based on viewport/resolution
          const nav = document.getElementById("bottomNav");
          if (!nav) return;

          const vh =
            window.innerHeight || document.documentElement.clientHeight;
          const vw = window.innerWidth || document.documentElement.clientWidth;
          const dpr = window.devicePixelRatio || 1;

          // Basic heuristics: devices with small heights need compact nav
          if (vh <= 640 || vw <= 360) {
            nav.style.height = "64px";
            nav
              .querySelectorAll(".bottom-nav-item")
              .forEach((b) => (b.style.fontSize = "11px"));
          } else if (vh <= 780) {
            nav.style.height = "72px";
            nav
              .querySelectorAll(".bottom-nav-item")
              .forEach((b) => (b.style.fontSize = "12px"));
          } else {
            nav.style.height = "80px";
            nav
              .querySelectorAll(".bottom-nav-item")
              .forEach((b) => (b.style.fontSize = "13px"));
          }

          // Ensure nav is fixed to the bottom safe area
          nav.style.position = "fixed";
          nav.style.left = "0";
          nav.style.right = "0";
          nav.style.bottom = "0";
          nav.style.zIndex = "60";

          // If device reports safe-area-inset, apply padding
          try {
            const inset = getComputedStyle(
              document.documentElement,
            ).getPropertyValue("--sat-inset-bottom");
            if (inset) nav.style.paddingBottom = inset;
          } catch (e) {}
        },

        addDemoData() {
          this.data.products = [
            {
              barcode: "000000000001",
              name: "Arroz 1kg",
              price: 45.0,
              stock: 30,
              category: "almacen",
            },
            {
              barcode: "000000000002",
              name: "Detergente 1L",
              price: 28.0,
              stock: 20,
              category: "limpieza",
            },
            {
              barcode: "000000000003",
              name: "Perfume 50ml",
              price: 250.0,
              stock: 12,
              category: "perfumeria",
            },
            {
              barcode: "7501055300078",
              name: "Coca Cola 600ml",
              price: 18.5,
              stock: 24,
              category: "bebidas",
            },
            {
              barcode: "000000000005",
              name: "Cigarrillos MarcaX 20",
              price: 55.0,
              stock: 40,
              category: "cigarrillos",
            },
            {
              barcode: "000000000006",
              name: "Tomate kg",
              price: 22.0,
              stock: 50,
              category: "verduras",
            },
            {
              barcode: "000000000007",
              name: "Leche 1L",
              price: 20.0,
              stock: 35,
              category: "lacteos",
            },
            {
              barcode: "000000000008",
              name: "Jam√≥n 200g",
              price: 60.0,
              stock: 18,
              category: "fiambreria",
            },
          ];
          this.saveData();
          this.renderProducts();
          this.updateDashboard();
        },

        // Enhanced Scanner Functions
        openScanner(mode) {
          this.scanMode = mode;
          this.scanHistory = [];
          document
            .getElementById("scannerInterface")
            .classList.remove("hidden-section");
          document.getElementById("lastScanned").style.display = "none";
          document.getElementById("scanHistoryContainer").style.display =
            "none";
          document.getElementById("manualBarcode").value = "";
          document.getElementById("manualBarcode").focus();

          this.startScanner();
        },

        async startScanner() {
          try {
            if (this.scanner) {
              await this.scanner.stop().catch(() => {});
            }

            this.scanner = new Html5Qrcode("reader", {
              verbose: false,
              useBarCodeDetectorIfSupported: true,
            });

            const config = {
              fps: 15,
              qrbox: { width: 250, height: 150 },
              aspectRatio: 1.0,
              disableFlip: false,
              formatsToSupport: [
                Html5QrcodeSupportedFormats.EAN_13,
                Html5QrcodeSupportedFormats.EAN_8,
                Html5QrcodeSupportedFormats.UPC_A,
                Html5QrcodeSupportedFormats.UPC_E,
                Html5QrcodeSupportedFormats.CODE_128,
                Html5QrcodeSupportedFormats.CODE_39,
                Html5QrcodeSupportedFormats.ITF,
              ],
            };

            await this.scanner.start(
              { facingMode: this.currentCamera },
              config,
              (decodedText) => {
                this.handleSuccessfulScan(decodedText);
              },
              (errorMessage) => {
                // Silently ignore scan errors (no valid code in frame)
              },
            );
          } catch (err) {
            console.error("Scanner error:", err);
            this.showError("Error al iniciar c√°mara: " + err.message);
            // Show manual entry as fallback
            document.getElementById("manualBarcode").focus();
          }
        },

        handleSuccessfulScan(barcode) {
          // Prevent duplicate scans within 3.5 seconds (increased for better UX)
          const now = Date.now();
          if (this.lastScanTime && now - this.lastScanTime < 3500) {
            if (this.lastScanCode === barcode) return;
          }
          this.lastScanTime = now;
          this.lastScanCode = barcode;

          // Add to history
          this.scanHistory.unshift({
            code: barcode,
            time: new Date().toLocaleTimeString(),
          });
          if (this.scanHistory.length > 5) this.scanHistory.pop();

          // Update UI
          document.getElementById("lastScanned").style.display = "block";
          document.getElementById("lastScannedCode").textContent = barcode;
          document.getElementById("scanHistoryContainer").style.display =
            "block";
          document.getElementById("scanHistory").innerHTML = this.scanHistory
            .map(
              (h) => `
                    <div class="scan-history-item">
                        <span>${h.code}</span>
                        <span>${h.time}</span>
                    </div>
                `,
            )
            .join("");

          // Vibrate if supported
          if (navigator.vibrate) navigator.vibrate([200, 100, 200]);

          // Add visual feedback - pulse effect on scanner frame
          const frame = document.querySelector(".scanner-frame");
          if (frame) {
            frame.style.borderColor = "#22c55e";
            frame.style.boxShadow = "0 0 20px rgba(34, 197, 94, 0.5)";
            setTimeout(() => {
              frame.style.borderColor = "rgba(255,255,255,0.5)";
              frame.style.boxShadow = "none";
            }, 500);
          }

          // Process based on mode with longer delay for better UX
          setTimeout(() => {
            this.processBarcode(barcode);
          }, 1000);
        },

        processBarcode(barcode) {
          if (this.scanMode === "new") {
            this.closeScanner();
            const exists = this.data.products.find(
              (p) => p.barcode === barcode,
            );
            if (exists) {
              this.showError("Producto ya existe: " + exists.name);
              setTimeout(() => this.editProduct(barcode), 500);
            } else {
              this.openProductModal(barcode);
            }
          } else if (this.scanMode === "search") {
            // Don't close scanner, just show info
            const product = this.data.products.find(
              (p) => p.barcode === barcode,
            );
            if (product) {
              this.showError(
                `‚úì ${product.name} - ${this.formatMoney(product.price)} (Stock: ${product.stock})`,
              );
              // Auto-close after showing
              setTimeout(() => {
                this.closeScanner();
                this.editProduct(barcode);
              }, 2000);
            } else {
              this.showError("Producto no encontrado");
              if (
                confirm("¬øCrear nuevo producto con c√≥digo " + barcode + "?")
              ) {
                this.closeScanner();
                this.openProductModal(barcode);
              }
            }
          } else if (this.scanMode === "sale") {
            const product = this.data.products.find(
              (p) => p.barcode === barcode,
            );
            if (product && product.stock > 0) {
              this.showError(
                `‚úì ${product.name} agregado ‚Ä¢ Stock: ${product.stock}`,
              );
              this.addToCart(product);
              // Keep scanner open and pause for next scan
              // Reset frame color for visual feedback
              const frame = document.querySelector(".scanner-frame");
              if (frame) {
                setTimeout(() => {
                  frame.style.borderColor = "rgba(255,255,255,0.5)";
                }, 500);
              }
            } else if (product && product.stock === 0) {
              this.showError("‚ö† Producto sin stock");
            } else {
              this.showError("Producto no encontrado");
              if (confirm("¬øCrear producto nuevo?")) {
                this.closeScanner();
                this.openProductModal(barcode);
              }
            }
          }
        },

        manualScan() {
          const code = document.getElementById("manualBarcode").value.trim();
          if (!code) {
            this.showError("Ingresa un c√≥digo");
            return;
          }
          this.handleSuccessfulScan(code);
        },

        async closeScanner() {
          try {
            if (this.scanner) {
              await this.scanner.stop();
              this.scanner = null;
            }
          } catch (e) {
            console.error("Error stopping scanner:", e);
          }
          document
            .getElementById("scannerInterface")
            .classList.add("hidden-section");
        },

        async switchCamera() {
          this.currentCamera =
            this.currentCamera === "environment" ? "user" : "environment";
          await this.startScanner();
        },

        async toggleTorch() {
          try {
            if (this.scanner && this.scanner.getRunningTrackCapabilities) {
              const capabilities = this.scanner.getRunningTrackCapabilities();
              if (capabilities.torch) {
                const settings = this.scanner.getRunningTrackSettings();
                await this.scanner.applyVideoConstraints({
                  advanced: [{ torch: !settings.torch }],
                });
              }
            }
          } catch (e) {
            this.showError("Flash no disponible");
          }
        },

        rescanBarcode() {
          this.closeModal("productModal");
          setTimeout(() => this.openScanner("new"), 300);
        },

        // Navigation
        navigateTo(page) {
          document.querySelectorAll(".bottom-nav-item").forEach((btn) => {
            btn.classList.remove("active", "text-indigo-600");
            btn.classList.add("text-gray-500");
            if (btn.dataset.page === page) {
              btn.classList.add("active", "text-indigo-600");
              btn.classList.remove("text-gray-500");
            }
          });

          document.querySelectorAll("main > section").forEach((section) => {
            section.classList.add("hidden-section");
          });

          const target = document.getElementById(page);
          if (target) target.classList.remove("hidden-section");

          const titles = {
            dashboard: "Dashboard",
            products: "Productos",
            sales: "Ventas",
            reports: "Reportes",
            settings: "Configuraci√≥n",
          };
          document.getElementById("pageTitle").textContent =
            titles[page] || "App";

          if (page === "dashboard") this.updateDashboard();
          if (page === "products") this.renderProducts();
          if (page === "sales") this.renderSales();
          if (page === "reports") this.updateReports();
        },

        // Dashboard
        updateDashboard() {
          const today = new Date().toDateString();
          const todaySales = this.data.sales.filter(
            (s) => new Date(s.date).toDateString() === today,
          );
          const total = todaySales.reduce((sum, s) => sum + s.total, 0);

          document.getElementById("todaySales").textContent =
            this.formatMoney(total);
          document.getElementById("totalProducts").textContent =
            this.data.products.length;

          const recentList = document.getElementById("recentSalesList");
          const recent = [...this.data.sales].reverse().slice(0, 5);

          if (recent.length === 0) {
            recentList.innerHTML =
              '<div class="text-center text-gray-400 py-4 text-sm">Sin ventas recientes</div>';
          } else {
            recentList.innerHTML = recent
              .map(
                (sale) => `
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl">
                            <div>
                                <div class="font-medium text-sm">Venta #${sale.id.toString().slice(-4)}</div>
                                <div class="text-xs text-gray-500">${new Date(sale.date).toLocaleTimeString()}</div>
                            </div>
                            <div class="font-bold text-indigo-600">${this.formatMoney(sale.total)}</div>
                        </div>
                    `,
              )
              .join("");
          }

          this.updateChart();
        },

        // Products
        renderProducts(filter = "all", search = "") {
          const grid = document.getElementById("productsGrid");
          let products = this.data.products;

          if (filter !== "all")
            products = products.filter((p) => p.category === filter);
          if (search)
            products = products.filter((p) =>
              p.name.toLowerCase().includes(search.toLowerCase()),
            );

          if (products.length === 0) {
            grid.innerHTML =
              '<div class="col-span-2 text-center text-gray-400 py-8 text-sm">No hay productos. ¬°Escanea uno nuevo!</div>';
            return;
          }

          grid.innerHTML = products
            .map(
              (product) => `
                    <div class="product-card bg-white p-3 rounded-2xl card-shadow" onclick="app.editProduct('${product.barcode}')">
                        <div class="aspect-square bg-gray-100 rounded-xl mb-2 flex items-center justify-center text-2xl">
                            ${product.category === "electronics" ? "üîå" : product.category === "food" ? "üçî" : "üì¶"}
                        </div>
                        <h4 class="font-medium text-sm truncate">${product.name}</h4>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-indigo-600 font-bold text-sm">${this.formatMoney(product.price)}</span>
                            <span class="text-xs ${product.stock < 5 ? "text-red-500 font-bold" : "text-green-600"}">${product.stock} uds</span>
                        </div>
                        <div class="text-xs text-gray-400 mt-1 font-mono">${product.barcode}</div>
                    </div>
                `,
            )
            .join("");
        },

        filterProducts() {
          const search = document.getElementById("searchInput").value;
          const activeCat =
            document.querySelector(".category-btn.bg-indigo-600")?.dataset
              .cat || "all";
          this.renderProducts(activeCat, search);
        },

        setCategory(cat) {
          // Toggle active class based on selected category without relying on global event
          document.querySelectorAll(".category-btn").forEach((btn) => {
            btn.classList.remove("bg-indigo-600", "text-white");
            btn.classList.add("bg-gray-200", "text-gray-700");
          });
          const target = document.querySelector(
            `.category-btn[data-cat="${cat}"]`,
          );
          if (target) {
            target.classList.remove("bg-gray-200", "text-gray-700");
            target.classList.add("bg-indigo-600", "text-white");
          }
          this.renderProducts(
            cat,
            document.getElementById("searchInput").value,
          );
        },

        // Product Modal
        openProductModal(barcode = "") {
          document.getElementById("productBarcode").value = barcode;
          document.getElementById("displayBarcode").value = barcode;
          document.getElementById("productName").value = "";
          document.getElementById("productPrice").value = "";
          document.getElementById("productStock").value = "";
          document.getElementById("productCategory").value = "food";
          document.getElementById("productModalTitle").textContent =
            "Nuevo Producto";
          document.getElementById("productModal").classList.add("active");
          document.getElementById("productName").focus();
        },

        editProduct(barcode) {
          const product = this.data.products.find((p) => p.barcode === barcode);
          if (!product) {
            this.showError("‚ùå Producto no encontrado");
            return;
          }

          document.getElementById("productBarcode").value = product.barcode;
          document.getElementById("displayBarcode").value = product.barcode;
          document.getElementById("productName").value = product.name;
          document.getElementById("productPrice").value = product.price;
          document.getElementById("productStock").value = product.stock;
          document.getElementById("productCategory").value = product.category;
          document.getElementById("productModal").classList.add("active");
          document.getElementById("productModalTitle").textContent =
            "Editar Producto";
        },

        saveProduct(e) {
          e.preventDefault();

          const barcode =
            document.getElementById("productBarcode").value ||
            Date.now().toString();
          const name = document.getElementById("productName").value?.trim();
          const price = parseFloat(
            document.getElementById("productPrice").value,
          );
          const stock = parseInt(document.getElementById("productStock").value);

          // Validations
          if (!name || name.length === 0) {
            this.showError("‚ùå El nombre del producto es requerido");
            document.getElementById("productName").focus();
            return;
          }

          if (isNaN(price) || price < 0) {
            this.showError("‚ùå Ingresa un precio v√°lido");
            document.getElementById("productPrice").focus();
            return;
          }

          if (isNaN(stock) || stock < 0) {
            this.showError("‚ùå Ingresa una cantidad v√°lida");
            document.getElementById("productStock").focus();
            return;
          }

          const product = {
            barcode: barcode,
            name: name,
            price: price,
            stock: stock,
            category: document.getElementById("productCategory").value,
          };

          const existingIndex = this.data.products.findIndex(
            (p) => p.barcode === barcode,
          );
          if (existingIndex >= 0) {
            this.data.products[existingIndex] = product;
            this.showError("‚úì Producto actualizado");
          } else {
            this.data.products.push(product);
            this.showError("‚úì Producto creado");
          }

          this.saveData();
          this.closeModal("productModal");
          this.renderProducts();
          this.updateDashboard();
        },

        // Sales
        openSaleModal() {
          console.log("=== openSaleModal() iniciando ===");
          
          // Asegurar que el modal simple se cierre
          const simpleModal = document.getElementById("saleModal");
          if (simpleModal) {
            simpleModal.classList.remove("active");
          }
          
          this.currentCart = [];
          const container = document.getElementById("saleSplitContainer");
          
          if (container) {
            console.log("Container encontrado, agregando clase active");
            // Limpiar estilos previos
            container.style.cssText = '';
            container.classList.add("active");
            
            // Establecer dimensiones EXPL√çCITAS basadas en el viewport
            const w = window.innerWidth;
            const h = window.innerHeight;
            
            container.style.position = 'fixed';
            container.style.top = '0px';
            container.style.left = '0px';
            container.style.width = w + 'px';
            container.style.height = h + 'px';
            container.style.zIndex = '2000';
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            
            console.log(`Dimensiones establecidas: ${w}x${h}`);
            
            // Actualizar UI primero
            this.updateSplitCartUI();
            
            // IMPORTANTE: Esperar a que el navegador renderice
            setTimeout(() => {
              console.log("Iniciando scanner despu√©s de 500ms...");
              this.startSaleScannerSplit();
            }, 500);
            
          } else {
            console.error("Container NO encontrado!");
          }
        },

        closeSplitSale() {
          try {
            if (this.scanner) {
              this.scanner.stop().catch(() => {});
              this.scanner = null;
            }
          } catch (e) {
            console.error("Error stopping split scanner:", e);
          }
          const container = document.getElementById("saleSplitContainer");
          if (container) {
            container.classList.remove("active");
            // Clear inline styles when closing
            container.style.cssText = '';
          }
          this.currentCart = [];
        },

        async startSaleScannerSplit() {
          console.log("=== startSaleScannerSplit() iniciando ===");
          console.log("Viewport:", window.innerWidth, "x", window.innerHeight);
          try {
            // Stop existing scanner if any
            if (this.scanner) {
              try {
                console.log("Deteniendo scanner anterior...");
                await this.scanner.stop();
              } catch (e) {
                console.warn("Error stopping previous scanner:", e);
              }
            }

            // Verificar que el contenedor PADRE sea visible
            const parentContainer = document.getElementById("saleSplitContainer");
            if (parentContainer) {
              const parentRect = parentContainer.getBoundingClientRect();
              const parentDisplay = window.getComputedStyle(parentContainer).display;
              const parentHeight = window.getComputedStyle(parentContainer).height;
              const parentWidth = window.getComputedStyle(parentContainer).width;
              console.log("sale-modal-split - display:", parentDisplay, "CSS height:", parentHeight, "CSS width:", parentWidth, "box:", Math.round(parentRect.width), "x", Math.round(parentRect.height));
            }

            // Ensure the container exists and is visible
            const container = document.getElementById("sale-reader");
            if (!container) {
              throw new Error("Scanner container 'sale-reader' not found");
            }
            console.log("sale-reader encontrado");

            // Verificar el contenedor padre tambi√©n
            const scannerSection = document.querySelector(".sale-scanner-section");
            if (scannerSection) {
              const sectionRect = scannerSection.getBoundingClientRect();
              const sectionDisplay = window.getComputedStyle(scannerSection).display;
              const sectionHeight = window.getComputedStyle(scannerSection).height;
              console.log("sale-scanner-section - display:", sectionDisplay, "CSS height:", sectionHeight, "box:", Math.round(sectionRect.width), "x", Math.round(sectionRect.height));
            }

            // Wait for DOM to render with proper dimensions
            let attempts = 0;
            let hasGoodDimensions = false;
            while (attempts < 30) {
              const rect = container.getBoundingClientRect();
              if (attempts % 5 === 0) {
                const display = window.getComputedStyle(container).display;
                console.log(`Intento ${attempts + 1}: sale-reader display=${display}, box-dimensiones=${Math.round(rect.width)}x${Math.round(rect.height)}`);
              }
              if (rect.height > 100 && rect.width > 100) {
                console.log("‚úì sale-reader tiene buenas dimensiones:", Math.round(rect.width), "x", Math.round(rect.height));
                hasGoodDimensions = true;
                break;
              }
              await new Promise(resolve => setTimeout(resolve, 100));
              attempts++;
            }

            const finalRect = container.getBoundingClientRect();
            console.log("Dimensiones FINALES de sale-reader:", Math.round(finalRect.width), "x", Math.round(finalRect.height));

            if (finalRect.width === 0 || finalRect.height === 0) {
              console.warn("‚ö†Ô∏è CR√çTICO: El contenedor sigue teniendo 0 dimensiones");
              console.log("Intentando establecer altura manualmente...");
              const scannerInner = container.parentElement;
              if (scannerInner) {
                const parentHeight = window.innerHeight * 0.55;
                scannerInner.style.height = parentHeight + 'px';
                container.style.height = parentHeight + 'px';
                console.log("Height forzado a:", parentHeight);
              }
            }

            // Force layout recalculation
            await new Promise(resolve => setTimeout(resolve, 200));

            console.log("Inicializando Html5Qrcode...");
            // Initialize Html5Qrcode
            this.scanner = new Html5Qrcode("sale-reader", {
              verbose: false,
              useBarCodeDetectorIfSupported: true,
            });

            const config = {
              fps: 15,
              qrbox: { width: 250, height: 150 },
              aspectRatio: 1.33,
              disableFlip: false,
              formatsToSupport: [
                Html5QrcodeSupportedFormats.EAN_13,
                Html5QrcodeSupportedFormats.EAN_8,
                Html5QrcodeSupportedFormats.UPC_A,
                Html5QrcodeSupportedFormats.UPC_E,
                Html5QrcodeSupportedFormats.CODE_128,
                Html5QrcodeSupportedFormats.CODE_39,
                Html5QrcodeSupportedFormats.ITF,
              ],
            };

            console.log("Intentando iniciar c√°mara...");
            await this.scanner.start(
              { facingMode: this.currentCamera },
              config,
              (decodedText) => {
                console.log("‚úì‚úì C√≥digo escaneado exitosamente:", decodedText);
                this.handleSuccessfulScanInSplit(decodedText);
              },
              (errorMessage) => {
                // Silently ignore scan errors
              },
            );

            console.log("‚úì‚úì‚úì Scanner iniciado exitosamente - LISTO");
            // Focus on manual input
            setTimeout(() => {
              const input = document.getElementById("saleScannerInput");
              if (input) input.focus();
            }, 100);
          } catch (err) {
            console.error("‚úó Error al iniciar scanner:", err.message);
            const errorMsg = err.message || "Error desconocido";
            alert("Error al iniciar c√°mara: " + errorMsg);
            // Still allow manual entry
            setTimeout(() => {
              const input = document.getElementById("saleScannerInput");
              if (input) input.focus();
            }, 100);
          }
        },

        handleSuccessfulScanInSplit(barcode) {
          // Prevent duplicate scans
          const now = Date.now();
          if (this.lastScanTime && now - this.lastScanTime < 3500) {
            if (this.lastScanCode === barcode) return;
          }
          this.lastScanTime = now;
          this.lastScanCode = barcode;

          // Vibrate if supported
          if (navigator.vibrate) navigator.vibrate([200, 100, 200]);

          // Process barcode
          this.processBarcodeSplit(barcode);
        },

        processBarcodeSplit(barcode) {
          const product = this.data.products.find((p) => p.barcode === barcode);
          if (product && product.stock > 0) {
            this.showError(
              `‚úì ${product.name} agregado ‚Ä¢ Stock: ${product.stock}`,
            );
            this.addToCart(product);
            this.updateSplitCartUI();
            // Highlight scanner
            const frame = document.querySelector(".sale-scanner-frame");
            if (frame) {
              frame.style.borderColor = "#22c55e";
              frame.style.boxShadow = "0 0 20px rgba(34, 197, 94, 0.5)";
              setTimeout(() => {
                frame.style.borderColor = "rgba(255,255,255,0.5)";
                frame.style.boxShadow = "none";
              }, 500);
            }
            // Clear input
            document.getElementById("saleScannerInput").value = "";
          } else if (product && product.stock === 0) {
            this.showError("‚ö† Producto sin stock");
          } else {
            this.showError("Producto no encontrado");
            if (confirm("¬øCrear producto nuevo?")) {
              this.closeSplitSale();
              this.openProductModal(barcode);
            }
          }
        },

        manualScanInSale() {
          const code = document.getElementById("saleScannerInput").value.trim();
          if (!code) {
            this.showError("Ingresa un c√≥digo");
            return;
          }
          this.handleSuccessfulScanInSplit(code);
        },

        updateSplitCartUI() {
          const container = document.getElementById("splitCartItems");
          const btn = document.getElementById("splitCompleteSaleBtn");
          const total = document.getElementById("splitCartTotal");
          const itemCount = document.getElementById("cartItemCount");

          // Only update if elements exist (split view mode)
          if (!container || !btn || !total) return;

          if (this.currentCart.length === 0) {
            container.innerHTML =
              '<div class="text-center text-gray-400 py-8 text-sm">Carrito vac√≠o ‚Ä¢ Escanea productos</div>';
            btn.disabled = true;
            btn.style.opacity = "0.5";
            if (itemCount) itemCount.textContent = "0 productos";
          } else {
            const totalItems = this.currentCart.reduce(
              (sum, item) => sum + item.quantity,
              0,
            );
            if (itemCount)
              itemCount.textContent = `${totalItems} ${totalItems === 1 ? "producto" : "productos"}`;

            container.innerHTML = this.currentCart
              .map((item, index) => {
                const product = this.data.products.find(
                  (p) => p.barcode === item.barcode,
                );
                const maxStock = product?.stock || 0;
                const subtotal = item.price * item.quantity;
                return `
                        <div class="p-3 bg-white border border-gray-200 rounded-lg transition-all hover:shadow-md hover:border-indigo-300">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1 min-w-0">
                                    <div class="font-semibold text-sm text-gray-900 truncate">${item.name}</div>
                                    <div class="text-xs text-gray-500 mt-0.5">${this.formatMoney(item.price)} c/u</div>
                                </div>
                                <button onclick="app.removeFromCart(${index})" class="text-red-500 hover:bg-red-50 p-2 rounded transition ml-2 flex-shrink-0" title="Eliminar producto">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="flex items-center gap-2 justify-between">
                                <div class="flex items-center gap-1 bg-gray-100 rounded-lg p-1">
                                    <button onclick="app.decrementCart(${index})" class="px-2 py-1 bg-gray-200 rounded text-xs font-bold hover:bg-gray-300 disabled:opacity-50" ${item.quantity <= 1 ? "disabled" : ""} title="Disminuir cantidad">‚àí</button>
                                    <span class="text-xs font-bold w-6 text-center">${item.quantity}</span>
                                    <button onclick="app.incrementCart(${index})" class="px-2 py-1 bg-gray-200 rounded text-xs font-bold hover:bg-gray-300 disabled:opacity-50" ${item.quantity >= maxStock ? "disabled" : ""} title="Aumentar cantidad">+</button>
                                </div>
                                <span class="font-bold text-indigo-600 text-sm">${this.formatMoney(subtotal)}</span>
                            </div>
                        </div>
                    `;
              })
              .join("");
            btn.disabled = false;
            btn.style.opacity = "1";
          }

          const cartTotal = this.currentCart.reduce(
            (sum, item) => sum + item.price * item.quantity,
            0,
          );
          total.textContent = this.formatMoney(cartTotal);
        },

        completeSaleFromSplit() {
          if (this.currentCart.length === 0) {
            this.showError("‚ùå Carrito vac√≠o");
            return;
          }

          const total = this.currentCart.reduce(
            (sum, item) => sum + item.price * item.quantity,
            0,
          );

          if (!confirm(`¬øCompletar venta por ${this.formatMoney(total)}?`)) {
            return;
          }

          const sale = {
            id: Date.now(),
            items: [...this.currentCart],
            total: total,
            date: new Date().toISOString(),
          };

          // Update product stock
          this.currentCart.forEach((item) => {
            const product = this.data.products.find(
              (p) => p.barcode === item.barcode,
            );
            if (product) product.stock -= item.quantity;
          });

          this.data.sales.push(sale);
          this.saveData();

          this.closeSplitSale();
          this.currentCart = [];
          this.showTicket(sale);
          this.updateDashboard();
          this.renderProducts();
        },

        openScannerInSale() {
          // This opens the scanner in the regular modal (fallback)
          this.scanMode = "sale";
          document.getElementById("saleModal").classList.add("active");
        },

        showProductSelector() {
          const list = document.getElementById("selectorList");
          const products = this.data.products.filter((p) => p.stock > 0);

          if (products.length === 0) {
            list.innerHTML =
              '<div class="text-center text-gray-400 py-8 text-sm">No hay productos en stock</div>';
          } else {
            list.innerHTML = products
              .map(
                (p) => `
                        <button type="button" onclick="app.selectProductFromList('${p.barcode}')" class="w-full flex justify-between items-center p-3 bg-white border border-gray-200 rounded-xl cursor-pointer hover:shadow-md hover:border-indigo-300 active:bg-indigo-50 transition">
                            <div class="text-left flex-1">
                                <div class="font-semibold text-sm text-gray-900">${p.name}</div>
                                <div class="text-xs text-gray-500 mt-0.5">${this.formatMoney(p.price)} ‚Ä¢ Stock: ${p.stock}</div>
                            </div>
                            <div class="text-indigo-600 ml-2">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            </div>
                        </button>
                    `,
              )
              .join("");
          }

          document
            .getElementById("productSelectorModal")
            .classList.add("active");
        },

        filterSelector() {
          const search = document
            .getElementById("selectorSearch")
            .value.toLowerCase();
          const items = document.querySelectorAll("#selectorList > div");
          items.forEach((item) => {
            const text = item.innerText.toLowerCase();
            item.style.display = text.includes(search) ? "flex" : "none";
          });
        },

        selectProductFromList(barcode) {
          const product = this.data.products.find((p) => p.barcode === barcode);
          if (product) {
            this.addToCart(product);
            this.closeModal("productSelectorModal");
          }
        },

        addToCart(product) {
          // Check stock availability
          if (!product || product.stock < 1) {
            this.showError("‚ùå Stock insuficiente");
            return;
          }

          const existing = this.currentCart.find(
            (item) => item.barcode === product.barcode,
          );
          if (existing) {
            // Check if product has enough stock for additional quantity
            const totalStock =
              this.data.products.find((p) => p.barcode === product.barcode)
                ?.stock || 0;
            if (existing.quantity < totalStock) {
              existing.quantity++;
              this.showError(`Cantidad aumentada a ${existing.quantity}`);
            } else {
              this.showError("‚ùå No hay suficiente stock para m√°s unidades");
              return;
            }
          } else {
            this.currentCart.push({ ...product, quantity: 1 });
          }
          this.updateCartUI();
          // Also update split view if it's visible
          const splitContainer = document.getElementById("saleSplitContainer");
          if (
            splitContainer &&
            splitContainer.classList.contains("active")
          ) {
            this.updateSplitCartUI();
          }
        },

        updateCartUI() {
          const container = document.getElementById("cartItems");
          const btn = document.getElementById("completeSaleBtn");

          // Only update if elements exist (regular modal mode)
          if (!container || !btn) return;

          if (this.currentCart.length === 0) {
            container.innerHTML =
              '<div class="text-center text-gray-400 py-8 text-sm">Carrito vac√≠o ‚Ä¢ Escanea un producto</div>';
            btn.disabled = true;
            btn.style.opacity = "0.5";
          } else {
            container.innerHTML = this.currentCart
              .map((item, index) => {
                const product = this.data.products.find(
                  (p) => p.barcode === item.barcode,
                );
                const maxStock = product?.stock || 0;
                const subtotal = item.price * item.quantity;
                return `
                        <div class="p-3 bg-white border border-gray-200 rounded-xl transition-all hover:shadow-md">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <div class="font-semibold text-sm text-gray-900">${item.name}</div>
                                    <div class="text-xs text-gray-500 mt-0.5">${this.formatMoney(item.price)} c/u</div>
                                </div>
                                <button onclick="app.removeFromCart(${index})" class="text-red-500 hover:bg-red-50 p-2 rounded-lg transition">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="app.decrementCart(${index})" class="px-3 py-1 bg-gray-100 rounded text-sm font-medium hover:bg-gray-200 disabled:opacity-50" ${item.quantity <= 1 ? "disabled" : ""}>‚àí</button>
                                <span class="text-sm font-bold min-w-[40px] text-center">${item.quantity}</span>
                                <button onclick="app.incrementCart(${index})" class="px-3 py-1 bg-gray-100 rounded text-sm font-medium hover:bg-gray-200 disabled:opacity-50" ${item.quantity >= maxStock ? "disabled" : ""}>+</button>
                                <span class="flex-1 text-right font-bold text-indigo-600">${this.formatMoney(subtotal)}</span>
                            </div>
                        </div>
                    `;
              })
              .join("");
            btn.disabled = false;
            btn.style.opacity = "1";
          }

          const total = this.currentCart.reduce(
            (sum, item) => sum + item.price * item.quantity,
            0,
          );
          const totalEl = document.getElementById("cartTotal");
          if (totalEl) totalEl.textContent = this.formatMoney(total);
        },

        incrementCart(index) {
          const item = this.currentCart[index];
          const product = this.data.products.find(
            (p) => p.barcode === item.barcode,
          );
          if (product && item.quantity < product.stock) {
            item.quantity++;
            this.updateCartUI();
            this.updateSplitCartUI();
          }
        },

        decrementCart(index) {
          const item = this.currentCart[index];
          if (item.quantity > 1) {
            item.quantity--;
            this.updateCartUI();
            this.updateSplitCartUI();
          }
        },

        removeFromCart(index) {
          const item = this.currentCart[index];
          if (confirm(`¬øEliminar "${item.name}" del carrito?`)) {
            this.currentCart.splice(index, 1);
            this.showError(`‚úì ${item.name} eliminado`);
            // Update both UI contexts if they exist
            this.updateCartUI();
            this.updateSplitCartUI();
          }
        },

        completeSale() {
          if (this.currentCart.length === 0) {
            this.showError("‚ùå Carrito vac√≠o");
            return;
          }

          const total = this.currentCart.reduce(
            (sum, item) => sum + item.price * item.quantity,
            0,
          );

          if (!confirm(`¬øCompletar venta por ${this.formatMoney(total)}?`)) {
            return;
          }

          const sale = {
            id: Date.now(),
            items: [...this.currentCart],
            total: total,
            date: new Date().toISOString(),
          };

          // Update product stock
          this.currentCart.forEach((item) => {
            const product = this.data.products.find(
              (p) => p.barcode === item.barcode,
            );
            if (product) product.stock -= item.quantity;
          });

          this.data.sales.push(sale);
          this.saveData();

          this.closeModal("saleModal");
          this.currentCart = [];
          this.showTicket(sale);
          this.updateDashboard();
          this.renderProducts();
        },

        showTicket(sale) {
          const content = document.getElementById("ticketContent");
          content.innerHTML = `
                    <div class="text-center border-b border-gray-300 pb-2 mb-2">
                        <div class="font-bold">${this.data.settings.businessName}</div>
                        <div class="text-xs text-gray-500">${new Date(sale.date).toLocaleString()}</div>
                    </div>
                    ${sale.items
                      .map(
                        (item) => `
                        <div class="flex justify-between text-xs">
                            <span>${item.name} x${item.quantity}</span>
                            <span>${this.formatMoney(item.price * item.quantity)}</span>
                        </div>
                    `,
                      )
                      .join("")}
                    <div class="border-t border-gray-300 pt-2 mt-2 flex justify-between font-bold">
                        <span>TOTAL</span>
                        <span>${this.formatMoney(sale.total)}</span>
                    </div>
                `;
          document.getElementById("ticketModal").classList.add("active");
        },

        renderSales() {
          const list = document.getElementById("salesList");
          const sales = [...this.data.sales].reverse();

          if (sales.length === 0) {
            list.innerHTML =
              '<div class="text-center text-gray-400 py-8 text-sm">No hay ventas registradas</div>';
            return;
          }

          list.innerHTML = sales
            .map(
              (sale) => `
                    <div class="bg-white p-4 rounded-2xl card-shadow" onclick="app.showTicketById(${sale.id})">
                        <div class="flex justify-between items-start mb-1">
                            <div>
                                <div class="font-bold text-gray-800 text-sm">Venta #${sale.id.toString().slice(-4)}</div>
                                <div class="text-xs text-gray-500">${new Date(sale.date).toLocaleDateString()}</div>
                            </div>
                            <div class="font-bold text-indigo-600">${this.formatMoney(sale.total)}</div>
                        </div>
                        <div class="text-xs text-gray-600">
                            ${sale.items.length} productos
                        </div>
                    </div>
                `,
            )
            .join("");
        },

        showTicketById(id) {
          const sale = this.data.sales.find((s) => s.id === id);
          if (sale) this.showTicket(sale);
        },

        // Reports
        setupCharts() {
          const ctx1 = document.getElementById("salesChart");
          if (ctx1) {
            this.charts.sales = new Chart(ctx1, {
              type: "line",
              data: {
                labels: ["Lun", "Mar", "Mi√©", "Jue", "Vie", "S√°b", "Dom"],
                datasets: [
                  {
                    label: "Ventas",
                    data: [0, 0, 0, 0, 0, 0, 0],
                    borderColor: "#6366f1",
                    backgroundColor: "rgba(99, 102, 241, 0.1)",
                    tension: 0.4,
                    fill: true,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                  y: { beginAtZero: true, display: false },
                  x: { grid: { display: false } },
                },
              },
            });
          }
        },

        updateChart() {
          if (!this.charts.sales) return;
          const data = new Array(7).fill(0);
          this.data.sales.forEach((sale) => {
            const day = new Date(sale.date).getDay();
            data[day] += sale.total;
          });
          this.charts.sales.data.datasets[0].data = data;
          this.charts.sales.update();
        },

        updateReports() {
          const total = this.data.sales.reduce((sum, s) => sum + s.total, 0);
          const items = this.data.sales.reduce(
            (sum, s) => sum + s.items.reduce((a, b) => a + b.quantity, 0),
            0,
          );

          document.getElementById("reportTotal").textContent =
            this.formatMoney(total);
          document.getElementById("reportItems").textContent = items;

          const ctx = document.getElementById("reportChart");
          if (this.charts.report) this.charts.report.destroy();

          this.charts.report = new Chart(ctx, {
            type: "bar",
            data: {
              labels: ["Sem 1", "Sem 2", "Sem 3", "Sem 4"],
              datasets: [
                {
                  data: [0, 0, 0, 0],
                  backgroundColor: "#6366f1",
                  borderRadius: 4,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
            },
          });
        },

        setReportRange(range) {
          document.querySelectorAll(".report-range-btn").forEach((btn) => {
            btn.classList.remove("bg-indigo-100", "text-indigo-700");
            btn.classList.add("bg-gray-100", "text-gray-600");
          });
          event.target.classList.remove("bg-gray-100", "text-gray-600");
          event.target.classList.add("bg-indigo-100", "text-indigo-700");
        },

        // Settings
        updateSettingsUI() {
          document.getElementById("settingsBusinessName").textContent =
            this.data.settings.businessName;
          document.getElementById("settingsBusinessType").textContent =
            this.data.settings.businessType;
          document.getElementById("currencyDisplay").textContent =
            this.data.settings.currency + " (" + this.getCurrencySymbol() + ")";
          document.getElementById("printTickets").checked =
            this.data.settings.printTickets;
        },

        editBusiness() {
          const name = prompt(
            "Nombre del comercio:",
            this.data.settings.businessName,
          );
          const type = prompt("Tipo:", this.data.settings.businessType);
          if (name) this.data.settings.businessName = name;
          if (type) this.data.settings.businessType = type;
          this.saveData();
          this.updateSettingsUI();
        },

        toggleCurrency() {
          const currencies = ["USD", "EUR", "MXN"];
          const current = currencies.indexOf(this.data.settings.currency);
          this.data.settings.currency =
            currencies[(current + 1) % currencies.length];
          this.saveData();
          this.updateSettingsUI();
          this.updateDashboard();
        },

        saveSettings() {
          this.data.settings.printTickets =
            document.getElementById("printTickets").checked;
          this.saveData();
        },

        // Utilities
        formatMoney(amount) {
          const symbols = { USD: "$", EUR: "‚Ç¨", MXN: "$" };
          const symbol = symbols[this.data.settings.currency] || "$";
          return symbol + parseFloat(amount).toFixed(2);
        },

        getCurrencySymbol() {
          const symbols = { USD: "$", EUR: "‚Ç¨", MXN: "$" };
          return symbols[this.data.settings.currency] || "$";
        },

        showError(message) {
          const toast = document.getElementById("errorToast");
          toast.textContent = message;
          toast.classList.add("show");
          setTimeout(() => toast.classList.remove("show"), 3000);
        },

        closeModal(id) {
          document.getElementById(id).classList.remove("active");
        },

        quickSale() {
          console.log("quickSale() called");
          // Open sale modal directly without navigating
          this.openSaleModal();
        },

        shareTicket() {
          if (navigator.share) {
            navigator.share({
              title: "Ticket de Venta",
              text: document.getElementById("ticketContent").innerText,
            });
          } else {
            alert("Compartir no soportado");
          }
        },

        exportData() {
          const dataStr = JSON.stringify(this.data, null, 2);
          const blob = new Blob([dataStr], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download =
            "comercio_backup_" +
            new Date().toISOString().split("T")[0] +
            ".json";
          a.click();
          URL.revokeObjectURL(url);
        },

        importData() {
          const input = document.createElement("input");
          input.type = "file";
          input.accept = ".json";
          input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
              try {
                const data = JSON.parse(event.target.result);
                if (data.products && data.sales) {
                  this.data = data;
                  this.saveData();
                  location.reload();
                } else {
                  this.showError("Archivo inv√°lido");
                }
              } catch (err) {
                this.showError("Error al leer archivo");
              }
            };
            reader.readAsText(file);
          };
          input.click();
        },

        clearData() {
          if (confirm("¬øBorrar TODOS los datos permanentemente?")) {
            if (confirm("¬øEst√°s completamente seguro?")) {
              localStorage.removeItem("comercioProData");
              location.reload();
            }
          }
        },
      };

      document.addEventListener("DOMContentLoaded", () => {
        app.init();
      });

      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) app.loadData();
      });
    </script>
  </body>
</html>
